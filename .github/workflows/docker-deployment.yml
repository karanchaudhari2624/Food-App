name: docker deployment

on: push

jobs: 
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Docker image build
        run: docker build -t ${{ vars.DOCKER_USERNAME }}/food-app:latest .

      - name: Docker image tag
        run: docker image tag ${{ vars.DOCKER_USERNAME }}/food-app:latest ${{ vars.DOCKER_USERNAME }}/food-app:${{ github.run_number }}

      - name: Docker Login
        uses: docker/login-action@v3.4.0
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push latest image to Docker Hub
        run: docker push ${{ vars.DOCKER_USERNAME }}/food-app:latest

      - name: Push tagged image for backup
        run: docker push ${{ vars.DOCKER_USERNAME }}/food-app:${{ github.run_number }}
        # ${{ github.run_number }} = GitHub predefined environment variable 

  old-deployment:
    needs: build
    runs-on: self-hosted
    steps:
      - name: Remove container
        run: docker container rm -f ${{ vars.CONTAINER_NAME }} || true

      - name: Remove old image
        run: docker rmi ${{ vars.DOCKER_USERNAME }}/food-app:latest || true

  deploy:
    needs: old-deployment
    runs-on: self-hosted
    steps:
      - name: Pull the image
        run: docker pull ${{ vars.DOCKER_USERNAME }}/food-app:latest

      - name: Run the container
        run: docker container run -dt --name ${{ vars.CONTAINER_NAME }} -p 80:80 ${{ vars.DOCKER_USERNAME }}/food-app:latest

      - name: Container status
        run: docker container ps -a
